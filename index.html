<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宝藏探索</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: rgba(245, 245, 245, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-image: url('洞穴.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            margin: 0;
        }

        h1 {
            position: absolute;
            top: 0;
            text-align: center;
            padding: 20px 0;
            font-family: '微软雅黑';
            color: #fff;
        }

       .container1 {
            position: absolute;
            top: 80px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-blend-mode: multiply;
        }

       .container2 {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-blend-mode: multiply;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

       .container3 {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-blend-mode: multiply;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        img {
            width: 200px;
            height: 200px;
            object-fit: cover;
            transition: opacity 0.8s ease-in-out;
        }

       .hidden {
            opacity: 0;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

       .result {
            margin-top: 10px;
            font-size: 18px;
            color: #fff;
        }

        /* 游戏历史容器样式 */
       .history-container {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            width: 300px;
        }

        /* 单个游戏历史项样式 */
       .history-item {
            padding: 5px 0;
            font-size: 14px;
            color: #333;
        }
    </style>
</head>

<body>
    <h1>宝藏探索</h1>
    <div class="container1">
        <img class="begin-image hidden" src="宝箱合上.png" alt="Begin Image">
        <button id="startButton" onclick="findTreasureWithPromises(this)">开始寻找宝藏</button>
        <div class="result" id="result1"></div>
    </div>
    <div class="container2">
        <img class="success-image hidden" src="宝箱打开.png" alt="Success Image">
        <div class="result" id="result2"></div>
    </div>
    <div class="container3">
        <img class="failed-image hidden" src="城堡守卫.png" alt="Failed Image">
        <div class="result" id="result3"></div>
    </div>
    <audio id="backgroundMusic" autoplay loop>
        <source src="music.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <audio id="successAudio" src="success.mp3"></audio>
    <audio id="failAudio" src="fail.mp3"></audio>
    <script>
        // 从本地存储获取玩家信息
        const playerInfo = JSON.parse(localStorage.getItem('playerInfo')) || {
            id: null,
            nickname: null,
            gameHistory: []
        };

        // 创建游戏历史容器并添加到页面
        const historyContainer = document.createElement('div');
        historyContainer.classList.add('history-container');
        document.body.appendChild(historyContainer);

        // 美化游戏历史显示
        playerInfo.gameHistory.forEach((game, index) => {
            const historyItem = document.createElement('p');
            historyItem.classList.add('history-item');
            historyItem.textContent = `游戏 ${index + 1} - ${game.date}: ${game.result}`;
            historyContainer.appendChild(historyItem);
        });

        let dataCache;

        async function loadData() {
            if (!dataCache) {
                const response = await fetch('data.txt');
                if (!response.ok) {
                    throw new Error('无法加载数据文件。');
                }
                const data = await response.text();
                dataCache = data.split('\n');
            }
            return dataCache;
        }

        class TreasureMap {
            static async asgetInitialClue() {
                const data = await loadData();
                const caveInfo = data.find(line => line.startsWith('洞穴'));
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve(  (caveInfo || '')+"在神秘的洞穴中找到了第一个线索...");
                    }, 4000);
                });
            }

            static async asdecodeAncientScript(clue) {
                const data = await loadData();
                const castleInfo = data.find(line => line.startsWith('城堡'));
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        if (!clue) {
                            reject("没有线索可以解码!");
                        }
                        resolve( "解码成功!宝藏在一座古老的城堡中..."+(castleInfo || '') );
                    }, 6000);
                });
            }

            static async searchCastle(location) {
                const data1 = await loadData();
                const guardInfo = data1.find(line => line.startsWith('城堡守卫'));
                const data2 = await loadData();
                const treasureInfo = data2.find(line => line.startsWith('宝箱'));
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const random = Math.random();
                        if (random < 0.4) {
                            reject( (guardInfo || '')+"糟糕!遇到了城堡守卫，被抓住..." );
                        }
                        resolve("找到了一个华丽的箱子..."+(treasureInfo || ''));
                    }, 6000);
                });
            }

            static openTreasureBox() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve("太棒了!任务成功！你找到了传奇宝藏!");
                    }, 5000);
                });
            }
        }

        async function findTreasureWithPromises(button) {
            button.disabled = true;
            document.querySelectorAll('.result').forEach(el => {
                el.textContent = '';
                el.classList.add('hidden');
                el.parentElement.querySelector('img').classList.add('hidden');
            });
            let originalBackground = document.body.style.backgroundImage;
            try {
                const clue = await TreasureMap.asgetInitialClue();
                showResult('#result1', clue);

                const location = await TreasureMap.asdecodeAncientScript(clue);
                if (location.includes("城堡")) {
                    document.body.style.backgroundImage = "url('古老城堡.png')";
                }
                showResult('#result1', location);
                const box = await TreasureMap.searchCastle(location);
                showResult('#result2', box);
                document.querySelector('#result2').parentElement.querySelector('img').classList.remove('hidden');
                const treasure = await TreasureMap.openTreasureBox();
                showResult('#result2', treasure);
                document.getElementById('successAudio').play();

                // 存储游戏历史
                playerInfo.gameHistory.push({
                    date: new Date().toLocaleString(),
                    result: '成功找到宝藏'
                });
                localStorage.setItem('playerInfo', JSON.stringify(playerInfo));


            } catch (error) {
                showResult('#result3', "任务失败: " + error);
                document.querySelector('#result3').parentElement.querySelector('img').classList.remove('hidden');
                document.getElementById('failAudio').play();

                // 存储游戏历史
                playerInfo.gameHistory.push({
                    date: new Date().toLocaleString(),
                    result: '任务失败，原因：遇到城堡守卫' 
                });
                localStorage.setItem('playerInfo', JSON.stringify(playerInfo));

            } finally {
                setTimeout(() => {
                    button.disabled = false;
                    document.querySelectorAll('.result').forEach(el => {
                        el.textContent = '';
                        el.classList.add('hidden');
                        el.parentElement.querySelector('img').classList.add('hidden');
                    });
                    document.querySelector('.container2 img').classList.add('hidden');
                    document.querySelector('.container3 img').classList.add('hidden');
                    document.body.style.backgroundImage = originalBackground;
                }, 9000);

            }
        }

        function showResult(selector, text) {
            const el = document.querySelector(selector);
            el.textContent = text;
            setTimeout(() => {
                el.classList.remove('hidden');
                el.parentElement.querySelector('img').classList.remove('hidden');
            }, 50);
        }
    </script>
</body>

</html>